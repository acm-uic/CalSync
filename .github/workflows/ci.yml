name: ci

on:
  push:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - name: Checkout repo 🛎
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'workflow_call' && 'main' || github.ref }}

      - name: Setup Deno 🔧
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Run linters and formatter checks 🚨
        run: |
          deno lint
          deno fmt --check
          deno check mod.ts

      - name: Package 📦
        run: deno compile --allow-net --allow-env --allow-read --target x86_64-unknown-linux-gnu -o dist/calsync-x86_64-unknown-linux-gnu mod.ts

      - name: Upload artifact ⬆️
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_call'
        uses: actions/upload-artifact@v3
        with:
          name: calsync-x86_64-unknown-linux-gnu
          path: dist/calsync-x86_64-unknown-linux-gnu
